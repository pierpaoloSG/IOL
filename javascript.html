<script>

function start(){ 
    console.log('start')
    createTableFiles()
    createTableDiffide()
}

$(document).ready(function() {

//controlla il click su tableFiles

      $("#tableFiles, #tableDiffide" ).on('click', function(){   
      var $table = this
      console.log('Hai cliccato su ' + $table.id)   
      var $checkedAll = $($table).find(".checkedAll")
      var $checkboxes = $($table).find("input[type=checkbox]")
      var $checkSingle = $($table).find(".checkSingle")
        $($checkedAll).change( function(){
          console.log('Hai clicclato su checkedAll')
         if ($($checkedAll).is(':checked')) {
            $($checkboxes).each(function () {
                $(this).prop("checked", true);
            });
          }
          else
          {
            $($checkboxes).each(function () {
                $(this).prop("checked", false);
            }); 
          }
        })

    //gestisce il change di checkedSingle  
    
    $($checkSingle).change(function () {
            if ($(this).is(":checked")){
            var isAllChecked = 0;
            $($checkSingle).each(function(){
              if(!this.checked)
                 isAllChecked = 1;
            })              
            if(isAllChecked == 0){ 
              $($checkedAll).prop("checked", true); 
              }     
          }
          else {
            $($checkedAll).prop("checked", false);
          };
        });
   })
  }) 


 // chiude il controllo della table      
  
//aggiorna la tableFiles (deve stare fuori dal .on della table
  
  $("#refreshTableFiles").click(function(){
      console.log('aggiorna la tabella')
         var $icon = $(this).find( ".glyphicon.glyphicon-repeat" );
                    if($icon.hasClass('glyphicon-repeat')) {
                        $icon.removeClass('glyphicon-repeat')
                        $icon.addClass('glyphicon-refresh')
                        $icon.addClass('glyphicon-refresh-animate')
                        // setTimeout is to indicate some async operation
                        window.setTimeout( function() {
                           $icon.removeClass('glyphicon-refresh')
                            $icon.removeClass('glyphicon-refresh-animate')
                            $icon.addClass('glyphicon-repeat')
                        }, 10000 );
      console.log('launch createTableFiles')
      }
      createTableFiles()

  });
  
   $('#import').on('click', function (e) {
              console.log('import clicked')
              // le checkbox non contengono l'attributo require, quindi il controllo viene fatto qui !
                var min = 1 //minumum number of boxes to be checked for this form-group
                var checkboxes = $(".checkSingle:checkbox:checked")
                if(checkboxes.length < min){
                  console.log('devi selezionare almeno ' + min + ' file/s')
                  return false
                  // è necessario selezionare almeno un file
                }
                $('#importOutput').html('')
                  // importa i dati dai file di affido selezionati
                  // gestisce l'animazione dell'icona del button importa
                  var $icon = $( this ).find( ".glyphicon.glyphicon-import" );
                    if($icon.hasClass('glyphicon-import')) {
                        $icon.removeClass('glyphicon-import')
                        $icon.addClass('glyphicon-refresh')
                        $icon.addClass('glyphicon-refresh-animate')
                       }
                 //compone l'array dei files selezionati
                 var files = []
                 var filesObj = {}
                  //var checkboxes = $("input:checkbox:checked");
                  $(checkboxes).each(function(){
                    var url = $(this).closest('tr').find('td').eq(2).html(); 
                    filesObj = {
                    'url':  url
                    }
                    console.filesObj
                    files.push(filesObj) 
                 });
                 
                  //legge i dati dai files di affido selezionati
                  console.log("files " + JSON.stringify(files))
                  google.script.run
                    .withSuccessHandler(onReadDiffide)
                    .withFailureHandler(onError2)
                    .readDiffideFromFiles(files)    
                  return false
          })
                function onReadDiffide(objDiffideDaInviare){
                    console.log('dati scritti su sheet')
                    // ricrea la tabella dei files aggiornata 
                    createTableFiles() 
                    // crea la tabella diffide
                       var $icon = $('#refreshTableFiles')
                       $icon.removeClass('glyphicon-refresh')
                       $icon.removeClass('glyphicon-refresh-animate')
                       $icon.addClass('glyphicon-import')
                       createTableDiffide(objDiffideDaInviare)
                }
                 
                function onError2(err){ 
                  
                  $('#outputPanelText').append(JSON.stringify(err))
                 }         
 

  $('#print').on('click', function (e) {
     
      var objDiffide = {
        'Data invio':''}
      var diffide = []
      var checkboxes = $("input.checkSingleDiffide:visible:checked");
      $(checkboxes).each(function(x){
            //var selected = $(this).closest('tr').find('td').eq(1).html() 
            if ($(this).closest('tr').find("td").eq(3).html() == ""){
                var selected = $(this).closest('tr').find('td').eq(1).html()
                diffide.push(selected)
            }
      });
      
      objDiffide.diffide = diffide.reverse()
      console.log('diffide to print ' + objDiffide.diffide)
      
      $('#dateModal').modal('show')
      $('#send').on('click', {objDiffide},  function (e) {
        objDiffide['Data invio'] = $("#dataInvio").find("input").val()
        if ($("#checkboxDiffide").is(':checked')){
           var runPrintDiffide = true
           $("input.checkSingleDiffide").prop('checked', false)
            printDiffide(objDiffide)     
            diffide = []
        }
        else
        {
          var runPrintDiffide = false
        }

      })
 })
 
 
  $('#insertExFlusso').on('click', function (e) {

      $('#exFlussoModal').modal('show');
      $('#formExFlusso').validator()
      console.log('shown modal')
       $('#formExFlusso').on('submit', function(e){
         $('#exFlussoModal').modal('hide')
         console.log('hidden')
         var objExFlusso =   $('#formExFlusso').serializeJSON()
         sendExFlusso(objExFlusso)
         return false
       }); 
      })
     

    $('#unDoLast').on('click', function (e) {
      var dates = []
      var colImportDate = $('#tableDiffide tr td:nth-child(10)') 
      var lastImport = Math.max.apply(Math, colImportDate.map(function(){
            var date = $(this).text()
            dates.push(date)
      return $(this).text()
      }))
      var lastImportDate = dates.reduce(function (a, b) { return a > b ? a : b; })
      $('#confirmModal').modal('show');
        $('#confirmOk').click(function(){
        console.log(lastImportDate)
        undoLastImport(lastImportDate)
        $('#confirmModal').modal('hide')
        });
      });              


// close document ready function

  

/*
//check click on tableDiffide

   $("#tableDiffide").on('click', function(){
   
   //manage change on checkedAllDiffide
      $("#checkedAllDiffide").change(function(){
        if(this.checked){
          $(".checkSingleDiffide").each(function(){
            this.checked=true;
            $("#print").removeAttr('disabled')
          })              
        }else{
          $(".checkSingleDiffide").each(function(){
            this.checked=false;
            $("#print").prop('disabled', true)
          })              
        }   
      });
      

//manage change on checkedSingleDiffide  
    $(".checkSingleDiffide").change(function () {
        if ($(this).is(":checked")){
           $("#print").removeAttr('disabled')
           var isAllChecked = 0;
        $(".checkSingleDiffide").each(function(){
          if(!this.checked)
             isAllChecked = 1;
        })
        if(isAllChecked == 0){ 
          $("#checkedAllDiffide").prop("checked", true); 
        }
      }
      else {
        $("#checkedAllDiffide").prop("checked", false);
        $("#print").prop('disabled', true)
      }  
    });  
    }); // non si capisce se è la chiusura del Document ready o no
  */

   

     


 // button Filter
        $('.filterable .btn-filter').click(function(){
        
        var $panel = $(this).parents('.filterable'),
        $filters = $panel.find('.filters input'),
        $tbody = $panel.find('.table tbody');
        
        if ($filters.prop('disabled') === true) {
            $filters.prop('disabled', false);
            
        } else {
            $filters.val('').prop('disabled', true);
            $tbody.find('.no-result').remove();
            $tbody.find('tr').show();
        }
    });
    
     $('#range').blur(function(e){
        /* Ignore tab key */
        var code = e.keyCode || e.which;
        if (code == '9') return;
        /* if esc is pressed we want to clear the value of search bo */
        if (code == 27 || $(this).val() == '') {
        $(this).val('');
        }
        /* Useful DOM data and selectors */
        var $input = $(this),
        rangeArray = $input.val().toLowerCase().split("-"),
        $panel = $input.parents('.filterable'),
        column = $panel.find('.filters th').index($input.parents('th')),
        $table = $panel.find('.table'),
        $rows = $table.find('tbody tr')
        /* filter function ;) */
        var $filteredRows = $rows.filter(function(){
            var $t = $(this);
            for (var i = rangeArray[0]; i < rangeArray[0]; ++i) {
              if ($t.is(":contains('" +i+ "')")) {
              return true;
            }
        }
        return false;
        })
        /* Clean previous no-result if exist */
        $table.find('tbody .no-result').remove();
        /* Show all rows, hide filtered ones (never do that outside of a demo ! xD) */
        $rows.show();
        $filteredRows.hide();
        /* Prepend no-result row if all rows are filtered */
        if ($filteredRows.length === $rows.length) {
            $table.find('tbody').prepend($('<tr class="no-result text-center"><td colspan="'+ $table.find('.filters th').length +'">No result found</td></tr>'));
        }
    }); 
  

    $('.filterable .filters input').not('#range').keyup(function(e){
        /* Ignore tab key */
        var code = e.keyCode || e.which;
        if (code == '9') return;
        //if esc is pressed we want to clear the value of search box
        if (code == 27 || $(this).val() == '') {
        $(this).val('');
        }
        /* Useful DOM data and selectors */
        var $input = $(this),
        inputContent = $input.val().toLowerCase(),
        $panel = $input.parents('.filterable'),
        column = $panel.find('.filters th').index($input.parents('th')),
        $table = $panel.find('.table'),
        $rows = $table.find('tbody tr');
        /* Dirtiest filter function ever ;) */
        var $filteredRows = $rows.filter(function(){
            var value = $(this).find('td').eq(column).text().toLowerCase();
            return value.indexOf(inputContent) === -1;
        });
        
        /* Clean previous no-result if exist */
        $table.find('tbody .no-result').remove();
        /* Show all rows, hide filtered ones */    
        $rows.show();
        $filteredRows.hide();
        var praticheFiltrate = $rows.length - $filteredRows.length 
        $("#praticheVisualizzate").html(praticheFiltrate)
        /* Prepend no-result row if all rows are filtered */
        if ($filteredRows.length === $rows.length) {
            $table.find('tbody').prepend($('<tr class="no-result text-center"><td colspan="'+ $table.find('.filters th').length +'">No result found</td></tr>'));
        }
    }); 
   


    function printDiffide(objDiffide){
      console.log('printDiffide ')
      var $icon = $('#print')
        $icon.removeClass('glyphicon-print')
        $icon.addClass('glyphicon-refresh')
        $icon.addClass('glyphicon-refresh-animate')
      google.script.run
      .withSuccessHandler(onPrintedDiffide)
      .withFailureHandler(onErrorPrinting)
      .retrieveDiffide(objDiffide)    
      return false
    }
      
      function onPrintedDiffide(results){   
        console.log('diffide printed')
        var $icon = $('#print')
        $icon.removeClass('glyphicon-refresh')
        $icon.removeClass('glyphicon-refresh-animate')
        $icon.addClass('glyphicon-print')
        var outputMessage
        var resultDate = moment().format("DD/MM/YYYY h:mm:ss ")
           var resultMessage = (results[0] == 1) ? ' diffida correttamente stampata ':' diffide correttamente stampate ' 
           outputMessage = "<p> " + resultDate + " - " + results[0] + " " + resultMessage +  " sul seguente documento: \n" +  "<a href='" +results[1]+"' target='_blank'>" +results[2]+ "</a><br>"
           outputMessage += resultDate + "- Lista di controllo: <a href='" +results[3]+"' target='_blank'>" +results[4]+ "</a><br>"
           //aggiorna la tabella diffide
           console.log(outputMessage)
        $('#outputPanelText').append(outputMessage)
      }
      
      function onErrorPrinting(err){
        console.log(err)
        $('#outputPanelText').append('Non è stato possibile stampare le diffide selezionate: ' + err)
      }
                 
       function printLabels(objDiffide){
      console.log('printDiffide')
      //var objDiffide = JSON.parse(JSONObjDiffide)
      google.script.run
      .withSuccessHandler(onPrintedLabels)
      .withFailureHandler(onErrorPrintingLabels)
      .retrieveAddresses(objDiffide)    
      showLoader()
      return false
    }
      
      function onPrintedLabels(results){   
       console.log('labels printed')
       var $icon = $('#print')
       $icon.removeClass('glyphicon-refresh')
       $icon.removeClass('glyphicon-refresh-animate')
       $icon.addClass('glyphicon-print')
        var outputMessage
        var resultDate = moment().format("dd/MM/YYYY h:mm:ss ")
        if (results[0]>1){
           resultMessage = results[0] + ' etichette correttamente stampate sul seguente file: \n'
        }
        else{
           resultMessage = results[0] + ' etichetta correttamente stampata sul seguente documento: \n'
        }
        outputMessage = resultDate + ' - ' + resultMessage + '<a href="'+ results[1]+'" target="_blank">' +results[2]+ '</a><br>'
        $('#outputPanelText').append(outputMessage)
      }
      
      function onErrorPrintingLabels(err){
        console.log(err)
        $('#printOutput').append('Non è stato possibile stampare le etichette per le diffide selezionate')
      }
     $('#range').blur(function(e){
        var range = $('#range').val()
     });


function createTableFiles(){
console.log('createTableFiles')
//legge i files affidi da importare presenti su folder
  google.script.run
    .withSuccessHandler(onImported)
    .withFailureHandler(onFailure)
    .readFilesAffidiFromFolder()
 }
 
 function onFailure(error) {
        var div = document.getElementById('outputPanelText');
        div.innerHTML = "ERROR: " + error.message;
 }
 
 function onImported(objFilesAffidi){
 var $icon = $('#refreshTableFiles')
       $icon.removeClass('glyphicon-refresh')
       $icon.removeClass('glyphicon-refresh-animate')
       $icon.addClass('glyphicon-repeat')
 var files = JSON.parse(objFilesAffidi)
 var myCheckbox = '' 
 var assegnati = 0
 var wroteOnTable = 0
 $('#tableFiles tbody').empty()
 if (files.length == 0) {
           $('#tableFiles thead').append('<th><td style="text-align: center" colspan="6">No result found</td></th>');        
 }
 else
 {
    for (var i=files.length-1; i>=0; i--){
        if (files[i]['Stato affido']){ //== 'Assegnato')
          assegnati++
          myCheckbox = '<label><input id="checkbox'+(i+1)+'" class="checkSingle" type="checkbox"></label>'
          tr = $('<tr>');
          tr.append("<td>" + myCheckbox + "</td>");
          tr.append("<td>" + files[i]['Nome del file'] + "</td>");
          tr.append("<td style='display: none'>" + files[i]['URL'] + "</td>");
          tr.append("<td>" + files[i]['Stato affido'] + "</td>");
          tr.append("<td>" + moment(files[i]['Data assegnazione']).format("DD/MM/YYYY hh:mm:ss ") + "</td>");
          if (files[i].Badge!='new') {
             if (files[i]['Data importazione']!='') {
              tr.append("<td>" + moment(files[i]['Data importazione']).format("DD/MM/YYYY hh:mm:ss ") + "</td>");
              }
              else
              {
              tr.append("<td></td>");
              }
             
          } else
          {  tr.append("<td> <span class='label label-info'>" + files[i].Badge + "</span> </td>");
          }
          $('#tableFiles').append(tr);
          wroteOnTable++
        } 
    }
 }     
     var resultDate = moment().format("dd/MM/YYYY hh:mm:ss ")
     switch(assegnati) {
     case 0:
     resultMessage = 'Non risultano files assegnati ancora da gestire.\n'
     break;
     case 1:
     resultMessage = 'Risulta ' + assegnati + ' file assegnato ancora da gestire.\n'
     break;
     default:
     resultMessage = 'Risultano ' + assegnati + ' files assegnati ancora da gestire.\n'
     break;
     }
        outputMessage = resultDate + ' - ' + resultMessage + '<br>'
        //$('#outputPanelText').append(outputMessage)
}


// Crea la TableDiffide

function createTableDiffide(){  
//legge dati affidi e crea tabella diffide
console.log('createTableDiffide')
google.script.run
  .withSuccessHandler(onReadDiffideDaInviare)
  .withFailureHandler(onErrorImporting)
  .readDiffideDaInviareFromSheet()
}


// withSuccessHandler di readDiffideDaInviare

  function onReadDiffideDaInviare(objAllDiffideDaInviare){
    var $icon = $( '#refreshTableFiles')
      $icon.removeClass('glyphicon-refresh') 
      $icon.addClass('glyphicon-repeat')
    var $icon = $( '#import')
      $icon.removeClass('glyphicon-refresh') 
      $icon.addClass('glyphicon-import')
      
    var diffide = JSON.parse(objAllDiffideDaInviare)
    console.log('DiffideDaInviare ')
    $('#tableDiffide tbody').remove()
        var tr
        if (diffide.length > 0){
          for (i=diffide.length-1; i>=0; i--){
          
                var myCheckbox = '<div vcenter> <label> <input id="checkbox'+(i+1)+'" class="checkSingle" type="checkbox"> </label> </div>'
                tr = $('<tr>');
                tr.append("<td >" + myCheckbox + "</td>");
                tr.append("<td id='idDiffida' >" + diffide[i]['ID diffida'] + "</td>");
                tr.append("<td >" + diffide[i]['Riferimento pratica']+"/"+diffide[i]['Tipologia flusso'] + "</td>");
                
                // crea badge nella colonna solo per pratiche ex-flusso
                if ( diffide[i]['Tipologia pratica'] == 'OPPOSIZIONE' || diffide[i]['Tipologia pratica'] == 'FALLIMENTO' || diffide[i]['Tipologia pratica'] == 'CONCORDATO'){ 
                    tr.append("<td ><span class='label label-warning'>" + diffide[i]['Tipologia pratica'] +"</span></td>");
                }else
                {
                    tr.append("<td ></td>")
                }
                    tr.append("<td >" + diffide[i]['Nome file affido'] + "</td>");
                    tr.append("<td >" + diffide[i]['Codice cliente'] + "</td>");
                    tr.append("<td >" + diffide[i]['Dato fiscale'] + "</td>");
                    tr.append("<td >" + diffide[i]['Ragione sociale'] + "</td>");
                    tr.append("<td >" + diffide[i]['Stato'] + "</td>");
                    tr.append("<td >" + moment(diffide[i]['Data importazione']).format("DD/MM/YYYY hh:mm:ss ") + "</td>");
                    //tr.append("<td >" + diffide[i]['Data importazione'] + "</td>")
                    
                if (diffide[i]['Data stampa']!='') {
                          tr.append("<td>" + moment(diffide[i]['Data stampa']).format("DD/MM/YYYY hh:mm:ss ") + "</td>");
                }
                else
                {
                     tr.append("<td></td>");
                }
                if (diffide[i]['Data invio']!='') {
                     tr.append("<td>" + moment(diffide[i]['Data invio']).format("DD/MM/YYYY") + "</td>");
                }
                else
                {
                     tr.append("<td></td>");
                }
               
                $('#tableDiffide').append(tr);  
          }
          console.log('table diffide created')
          $("#praticheVisualizzate").html(diffide.length)
          var colImportDate = $('#tableDiffide tr td:nth-child(9)')        
          var high = Math.max.apply(Math, colImportDate.map(function(){
             var date = $(this).text()
             return $(this).text()
           }))
        }
        else
        {
           $('#tableDiffide tbody').prepend($('<tr class="no-result text-center"><td colspan="">No result found</td></tr>'));
        }
 }


function onErrorImporting(err){
     console.log(err)
}

//**************************
//sendExFlusso - inserisce exFlusso

function sendExFlusso(objExFlusso){
console.log('sendExFlusso')
google.script.run
  .withSuccessHandler(onSentExFlusso)
  .withFailureHandler(onErrorExFlusso)
  .insertExFlusso(objExFlusso)
}

function onSentExFlusso(message){
    createTableDiffide()

}


  function onErrorExFlusso(message){
 
     console.log(message)
 
   }


//**************************
//unDoLastImport - cancella l'ultima importazione

function undoLastImport(lastImportDate){

console.log('undoLastImport')
//legge i files affidi da importare presenti su folder
  google.script.run
    .withSuccessHandler(onUndoSuccess)
    .withFailureHandler(onFailure)
    .deleteLastImportedDiffide(lastImportDate)
 }
 
// function onFailure(error) {
//        var div = document.getElementById('outputPanelText');
//        div.innerHTML = "ERROR: " + error.message;
// }
// 
 function onUndoSuccess(message){
 
 console.log(message)
 
 }
 

</script>


